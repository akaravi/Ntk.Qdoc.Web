@page "/"
@page "/{id}"
@inject IChatService ChatService
@inject IConnectedClientService ConnectedClientService
@inject NavigationManager UriHelper
@inject IJSRuntime JsRuntime

@if (null == ConnectedClientService?.Client)
{
	<p>waiting for connection...</p>
}
else
{
	@if (ShowIntroModal)
	{
		<div class="app-modal-backdrop">
			<div class="app-modal">
				<h2 class="app-modal-title">راهنمای استفاده از سیستم پیام‌رسان</h2>
				<p>
					این سیستم پیام‌رسان بدون استفاده از بانک اطلاعات و بر اساس فناوری سوکت پیاده‌سازی شده است
					و هیچ‌یک از پیام‌ها و داده‌های شما در سرور ذخیره نمی‌شود.
				</p>
				<p>
					در صورتی که در متن چت آدرس یک وب‌سایت را وارد کنید، طرف مقابل شما  به آن وب‌سایت منتقل می شود؛ بنابراین این سیستم برای پشتیبانی و راهنمایی آنلاین بسیار مناسب است.
				</p>
				<button class="btn btn-primary btn-block mt-3" @onclick="CloseIntroModal">متوجه شدم</button>
			</div>
		</div>
	}

	@if (ViewMainComponent)
	{

		var view = "scan";

		<div class="hero-section">
			<div class="surface-card qr-card">
				<h1 class="h4 mb-3 font-weight-bold">این بارکد را اسکن کنید</h1>
				<p class="sub-text">کد ورود منحصر به فرد شما برای اتصال سریع</p>
				<img src="@_qRCodeBase64" alt="qr-code" />
				<div class="code-pill">
					<span>کد شما:</span>
					<strong>@this.User.Username</strong>
				</div>
				<div class="hero-actions">
					<button @onclick="() => ActionChangePage(view)" class="btn btn-lg btn-primary btn-block mt-2" type="button">بارکد سایرین را اسکن کنید</button>
					<button @onclick='@(() => ActionChangePage("multichat"))' class="btn btn-lg btn-outline-primary btn-block mt-2" type="button">
						<i class="fa fa-comments"></i> چت‌های من
					</button>
				</div>
			</div>
		</div>

	}
	@if (ViewScanComponent)
	{
		var view = "main";

		<div class="card-stack">
			<div class="surface-card">
				<h2 class="section-title">کد مخاطب را وارد یا اسکن کنید</h2>
				<p class="sub-text">برای شروع گفتگو، کد را اسکن یا دستی وارد کنید</p>
				<ScanDevice LoggedUser="User" onActionUserFind="(x)=>ActionScanedDevice(x)"></ScanDevice>
				<br />
				<button @onclick="() => ActionChangePage(view)" class="btn btn-lg btn-primary btn-block" type="button">بازگشت</button>
			</div>
		</div>
	}
	@if (ViewSendMessageComponent)
	{
		<div class="surface-card">
			<h2 class="section-title">ارسال پیام</h2>
			<p class="sub-text">پیامی را به مخاطب انتخاب‌شده ارسال کنید</p>
			<MessageForm LoggedUser="@User" ReceiverUsername="@ReceiverUsername" />
		</div>
	}
	@if (ViewGetMessageComponent)
	{
		<div class="surface-card">
			<Chat CurrentUser="@User.Username" ReceiverUsername="@ReceiverUsername" />
			<MessageForm LoggedUser="@User" ReceiverUsername="@ReceiverUsername" />
		</div>
	}
	@if (ViewChatRoomComponnet)
	{
		<div class="chat-layout">
			<Users CurrentUser="@User.Username" AllowMultiSelect="false" />
			<div class="surface-card">
				<Chat CurrentUser="@User.Username" ReceiverUsername="@ReceiverUsername" />
				<MessageForm LoggedUser="@User" ReceiverUsername="@ReceiverUsername" AllowGetReceiverUsername="@true" />
			</div>
		</div>
	}
	@if (ViewMultiChatComponent)
	{
		<div class="surface-card">
			<MultiChatView CurrentUser="@User.Username" />
		</div>
	}
}


@code {
	[Parameter]
	public string id { get; set; }
	public UserModel User { get; private set; }
	public UserModel ScanedUser { get; set; }

	private List<MessageModel>
	_messages;

	private string _qRCodeBase64 = "";

	private bool ViewMainComponent = true;
	private bool ViewSendMessageComponent = false;
	private bool ViewGetMessageComponent = false;
	private bool ViewScanComponent = false;
	private bool ViewChatRoomComponnet = false;
	private bool ViewMultiChatComponent = false;
	private PostMessageViewModel _message = new PostMessageViewModel();
	private string ReceiverUsername = "";
	private bool ShowIntroModal = true;
	protected override void OnInitialized()
	{
		if (null != this.ChatService)
		{
			this.ChatService.UserLoggedIn += OnUserLoggedIn;
			ChatService.MessageReceived += OnMessage;
			ChatService.UserLoggedOut += OnUserLoggedOut;
			_messages = new List<MessageModel>
			();
		}
		this.User = new UserModel(ChatHelper.RandomString(5));
		_qRCodeBase64 = "data:image/jpg;base64," + QRCodeHelper.UrlToQRCode(UriHelper.BaseUri + this.User.Username, QRCodeHelper.ECCLevel.H);
	}

	private async void OnMessage(object sender, MessageModel message)
	{

		if (message.Username == User.Username || message.ReceiverUsername == User.Username)
		{
			if (message.ReceiverUsername == User.Username)
			{
				if (message.Text.ToLower().IndexOf("https://") == 0 || message.Text.ToLower().IndexOf("http://") == 0)
				{
					UriHelper.NavigateTo(message.Text);
					await InvokeAsync(StateHasChanged);
					return;
				}
			}
			if (message.ReceiverUsername == User.Username)
			{
				this.ReceiverUsername = message.Username;
			}

			_messages.Add(message);
			await this.ActionChangePage("get");
		}
	}
	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		await base.OnAfterRenderAsync(firstRender);
		if (firstRender)
		{
			this.User = this.ChatService.Login(User.Username, this.ConnectedClientService.Client);
			if (!string.IsNullOrEmpty(id))
			{
			if (id == "room")
			{
				await ActionChangePage("room");
			}
			else if (id == "multichat")
			{
				await ActionChangePage("multichat");
			}
				else
				{
					ScanedUser = ChatService.CheckUserExist(this.User, id);
					if (this.ScanedUser != null && !string.IsNullOrEmpty(ScanedUser.Username))
					{
						this.ReceiverUsername = ScanedUser.Username;
						await ActionChangePage("send");
					}
				}
			}
		}
	}

	private async void OnUserLoggedIn(object sender, UserLoginEventArgs args)
	{
		await InvokeAsync(this.StateHasChanged);
	}
	private async void OnUserLoggedOut(object sender, UserLogoutEventArgs args)
	{
		if (string.IsNullOrEmpty(this.ReceiverUsername))
			return;

		var _users = this.ChatService.GetAllUsers();
		if (!_users.Any(x => x.Username == this.ReceiverUsername))
		{
			await JsRuntime.InvokeVoidAsync("alert", "شناسه مورد نظر از ارتباط خارج شد"); // Alert

			await ActionChangePage("main");
		}

	}
	private void Dispose()
	{
		if (null != this.ChatService)
		{
			this.ChatService.UserLoggedIn -= OnUserLoggedIn;

			this.ChatService.MessageReceived -= OnMessage;
		}

	}

	private string title(string str)
	{
		if (str == User.Username)
			return str + "(me)";
		return str;
	}
	private string viewLast = "";
	private async Task ActionChangePage(string view)
	{
		// اگر multichat انتخاب شد، به صفحه جداگانه هدایت می‌کنیم
		if (view == "multichat")
		{
			UriHelper.NavigateTo("/multichat");
			return;
		}

		if (viewLast == view || (viewLast == "room" && view == "room"))
		{
			await InvokeAsync(StateHasChanged);
			return;
		}
		viewLast = view;
		ViewScanComponent = false;
		ViewMainComponent = false;
		ViewSendMessageComponent = false;
		ViewGetMessageComponent = false;
		ViewChatRoomComponnet = false;
		ViewMultiChatComponent = false;
		switch (view)
		{
			case "main":
				ViewMainComponent = true;
				break;
			case "scan":
				ViewScanComponent = true;
				break;
			case "send":
				ViewSendMessageComponent = true;
				break;
			case "get":
				ViewGetMessageComponent = true;
				break;
			case "room":
				ViewChatRoomComponnet = true;
				break;
			case "multichat":
				ViewMultiChatComponent = true;
				break;
		}
		// this.StateHasChanged();
		await InvokeAsync(StateHasChanged);
	}

	private async void ActionScanedDevice(UserModel model)
	{
		this.ScanedUser = model;
		this.ReceiverUsername = ScanedUser.Username;
		await this.ActionChangePage("send");
	}
	private void CloseIntroModal()
	{
		ShowIntroModal = false;
	}
            }
