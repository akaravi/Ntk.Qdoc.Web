@inject IChatService ChatService
@using System
@using System.Linq
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Ntk.Qdoc.Web.Blazor.Models
@implements IDisposable

<div class="multi-chat-view">
	<div class="chat-threads-panel">
		<div class="chat-threads-header">
			<h3>Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</h3>
			<button class="btn btn-sm btn-primary" @onclick="ShowCreateGroupChat">
				<i class="fa fa-plus"></i> Ú†Øª Ø¬Ø¯ÛŒØ¯
			</button>
		</div>
		
		<div class="new-chat-input-section">
			<div class="input-group">
				<InputText @bind-Value="_newChatUsername" 
						   @onkeypress="OnKeyPress"
						   @onkeydown="OnKeyDown"
						   @oninput="OnInputChanged"
						   pattern="[0-9]*"
						   inputmode="numeric"
						   type="text"
						   class="form-control" 
						   placeholder="Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ø§ÛŒ Ú†Øª Ø¬Ø¯ÛŒØ¯..." />
				<button class="btn btn-sm btn-primary" @onclick="StartChatByUsername" title="Ø´Ø±ÙˆØ¹ Ú†Øª">
					<i class="fa fa-search"></i>
				</button>
			</div>
		</div>
		
		@if (_previousChatUsers != null && _previousChatUsers.Any())
		{
			<div class="previous-chats-section">
				<h4 class="previous-chats-title">
					<i class="fa fa-history"></i> Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
				</h4>
				<div class="previous-chats-list">
					@foreach (var username in _previousChatUsers)
					{
						<div class="previous-chat-item" @onclick="() => StartPrivateChat(username)">
							<i class="fa fa-user"></i>
							<span>@username</span>
							<i class="fa fa-chevron-left"></i>
						</div>
					}
				</div>
			</div>
		}
		
		<div class="chat-threads-list">
			@if (_chatThreads != null && _chatThreads.Any())
			{
				foreach (var thread in _chatThreads)
				{
					var unreadCount = thread.GetUnreadCount(CurrentUser);
					var isSelected = false;
					
					// Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÙˆØ¯Ù† thread
					if (!string.IsNullOrEmpty(thread.ChatId))
					{
						isSelected = SelectedChatId == thread.ChatId;
					}
					else if (thread.Participants.Count == 2)
					{
						var otherParticipant = thread.Participants.FirstOrDefault(p => p != CurrentUser);
						isSelected = _selectedReceiverUsername == otherParticipant;
					}
					
					<div class="chat-thread-item @(isSelected ? "active" : "")" 
						 @onclick="() => SelectThread(thread)">
						<div class="thread-info">
							<div class="thread-name">
								@if (thread.IsGroupChat)
								{
									<i class="fa fa-users"></i>
								}
								else
								{
									<i class="fa fa-user"></i>
								}
								@thread.ChatName
							</div>
							<div class="thread-preview">@(string.IsNullOrEmpty(thread.LastMessagePreview) ? "Ø¨Ø¯ÙˆÙ† Ù¾ÛŒØ§Ù…" : thread.LastMessagePreview)</div>
						</div>
						@if (unreadCount > 0)
						{
							<span class="unread-badge">@unreadCount</span>
						}
						<div class="thread-time">@FormatTime(thread.LastMessageTime)</div>
					</div>
				}
			}
			else
			{
				<div class="empty-state">Ù‡ÛŒÚ† Ú†ØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>
			}
		</div>
	</div>

	<div class="chat-content-panel">
		@if (!string.IsNullOrEmpty(SelectedChatId))
		{
			<Chat CurrentUser="@CurrentUser" ChatId="@SelectedChatId" @key="@SelectedChatId" />
			<MessageForm LoggedUser="@_loggedUser" ChatId="@SelectedChatId" />
		}
		else if (!string.IsNullOrEmpty(_selectedReceiverUsername))
		{
			<Chat CurrentUser="@CurrentUser" ReceiverUsername="@_selectedReceiverUsername" @key="@_selectedReceiverUsername" />
			<MessageForm LoggedUser="@_loggedUser" ReceiverUsername="@_selectedReceiverUsername" />
		}
		else
		{
			<div class="empty-chat-state">
				<div class="empty-icon">ğŸ’¬</div>
				<p>ÛŒÚ© Ú†Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ú†Øª Ø¬Ø¯ÛŒØ¯ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯</p>
			</div>
		}
	</div>
</div>

@if (_showCreateGroupDialog)
{
	<div class="modal-overlay" @onclick="CloseCreateGroupDialog">
		<div class="modal-content" @onclick:stopPropagation="true">
			<div class="modal-header">
				<h3>Ø§ÛŒØ¬Ø§Ø¯ Ú†Øª Ú¯Ø±ÙˆÙ‡ÛŒ</h3>
				<button class="btn-close" @onclick="CloseCreateGroupDialog">Ã—</button>
			</div>
			<div class="modal-body">
				<div class="form-group">
					<label>Ù†Ø§Ù… Ú†Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
					<InputText @bind-Value="_newChatName" class="form-control" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªÛŒÙ… ØªÙˆØ³Ø¹Ù‡" />
				</div>
				<Users CurrentUser="@CurrentUser" AllowMultiSelect="true" 
					   OnCreateGroupChatRequested="@HandleCreateGroupChat" />
			</div>
		</div>
	</div>
}

@code {
	[Parameter]
	public string CurrentUser { get; set; }

	private IEnumerable<ChatThreadModel> _chatThreads;
	private string SelectedChatId { get; set; }
	private string _selectedReceiverUsername { get; set; }
	private bool _showCreateGroupDialog = false;
	private string _newChatName = "";
	private string _newChatUsername = "";
	private UserModel _loggedUser;
	private List<string> _previousChatUsers;

	protected override void OnInitialized()
	{
		_loggedUser = new UserModel(CurrentUser);
		LoadChatThreads();
		LoadPreviousChatUsers();

		if (ChatService != null)
		{
			ChatService.MessageReceived += OnMessageReceived;
		}
	}

	private void LoadChatThreads()
	{
		if (!string.IsNullOrEmpty(CurrentUser))
		{
			// Ù†Ù…Ø§ÛŒØ´ ØªÙ…Ø§Ù… threadÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¢Ù†Ù‡Ø§ Ø§Ø³Øª (Ù‡Ù…Ù‡ Ú†Øªâ€ŒÙ‡Ø§ - Ù†Ù‡ ÙÙ‚Ø· ÙØ¹Ø§Ù„)
			_chatThreads = ChatService.GetChatThreadsForUser(CurrentUser);
		}
	}

	private void LoadPreviousChatUsers()
	{
		if (!string.IsNullOrEmpty(CurrentUser))
		{
			_previousChatUsers = ChatService.GetUsersWithPrivateChatHistory(CurrentUser);
		}
	}

	protected override async Task OnParametersSetAsync()
	{
		// ÙˆÙ‚ØªÛŒ CurrentUser ØªØºÛŒÛŒØ± Ú©Ø±Ø¯ØŒ threadÙ‡Ø§ Ùˆ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù‚Ø¨Ù„ÛŒ Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†
		LoadChatThreads();
		LoadPreviousChatUsers();
		await base.OnParametersSetAsync();
	}

	private async void SelectThread(ChatThreadModel thread)
	{
		if (thread == null)
			return;

		// Ø§Ú¯Ø± thread Ú¯Ø±ÙˆÙ‡ÛŒ Ø§Ø³ØªØŒ Ø§Ø² ChatId Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
		if (!string.IsNullOrEmpty(thread.ChatId))
		{
			SelectedChatId = thread.ChatId;
			_selectedReceiverUsername = null;
		}
		else
		{
			// Ø§Ú¯Ø± thread Ø®ØµÙˆØµÛŒ Ø§Ø³ØªØŒ Ø§Ø² ReceiverUsername Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
			var otherParticipant = thread.Participants.FirstOrDefault(p => p != CurrentUser);
			if (!string.IsNullOrEmpty(otherParticipant))
			{
				_selectedReceiverUsername = otherParticipant;
				SelectedChatId = null;
			}
		}
		
		// Reset unread count when chat is selected
		thread.ResetUnreadCount(CurrentUser);
		await InvokeAsync(StateHasChanged);
	}

	private void StartPrivateChat(string username)
	{
		if (string.IsNullOrEmpty(username))
			return;

		// Ø´Ø±ÙˆØ¹ Ú†Øª Ø®ØµÙˆØµÛŒ Ø¨Ø§ Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
		SelectedChatId = null;
		_selectedReceiverUsername = username;
		
		// threadÙ‡Ø§ Ø±Ø§ refresh Ú©Ù† ØªØ§ thread Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯
		LoadChatThreads();
		InvokeAsync(StateHasChanged);
	}

	private async Task OnKeyPress(KeyboardEventArgs e)
	{
		// Ø§Ú¯Ø± Enter ÙØ´Ø±Ø¯Ù‡ Ø´Ø¯ØŒ Ú†Øª Ø±Ø§ Ø´Ø±ÙˆØ¹ Ú©Ù†
		if (e.Key == "Enter")
		{
			await StartChatByUsername();
			return;
		}

		// ÙÙ‚Ø· Ø§Ø¹Ø¯Ø§Ø¯ Ø±Ø§ Ø¨Ù¾Ø°ÛŒØ±
		if (!string.IsNullOrEmpty(e.Key) && e.Key.Length == 1)
		{
			if (!char.IsDigit(e.Key[0]))
			{
				// Ø§Ú¯Ø± Ø¹Ø¯Ø¯ Ù†Ø¨ÙˆØ¯ØŒ Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ Ø¯Ø± Ø³Ø·Ø­ input Ú©Ù†ØªØ±Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (Ø§Ø² Ø·Ø±ÛŒÙ‚ OnInputChanged)
			}
		}
	}

	private void OnKeyDown(KeyboardEventArgs e)
	{
		// Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„ (Backspace, Delete, Arrow keys, Tab, etc.)
		var allowedKeys = new[] { "Backspace", "Delete", "ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown", "Tab", "Home", "End", "Enter" };
		if (allowedKeys.Contains(e.Key))
		{
			return; // Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ø§ÛŒÙ† Ú©Ù„ÛŒØ¯Ù‡Ø§
		}

		// Ø§Ú¯Ø± Ú©Ù„ÛŒØ¯ Ctrl ÛŒØ§ Alt ÙØ´Ø±Ø¯Ù‡ Ø´Ø¯Ù‡ØŒ Ø§Ø¬Ø§Ø²Ù‡ Ø¨Ø¯Ù‡ (Ø¨Ø±Ø§ÛŒ copy/paste)
		if (e.CtrlKey || e.AltKey || e.MetaKey)
		{
			return;
		}

		// Ø¨Ø±Ø§ÛŒ Ø³Ø§ÛŒØ± Ú©Ù„ÛŒØ¯Ù‡Ø§ØŒ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù† Ú©Ù‡ Ø¢ÛŒØ§ Ø¹Ø¯Ø¯ Ø§Ø³Øª
		if (!string.IsNullOrEmpty(e.Key) && e.Key.Length == 1)
		{
			if (!char.IsDigit(e.Key[0]))
			{
				// Ø§Ú¯Ø± Ø¹Ø¯Ø¯ Ù†Ø¨ÙˆØ¯ØŒ Ù…Ù‚Ø¯Ø§Ø± ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø² Ø·Ø±ÛŒÙ‚ OnInputChanged ÙÛŒÙ„ØªØ± Ù…ÛŒâ€ŒØ´ÙˆØ¯
			}
		}
	}

	private void OnInputChanged(ChangeEventArgs e)
	{
		// Ø­Ø°Ù ØªÙ…Ø§Ù… Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ ØºÛŒØ± Ø¹Ø¯Ø¯ÛŒ Ø§Ø² Ù…Ù‚Ø¯Ø§Ø± ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡
		if (e.Value != null)
		{
			var inputValue = e.Value.ToString();
			var numericOnly = new string(inputValue.Where(char.IsDigit).ToArray());
			_newChatUsername = numericOnly;
		}
	}

	private async Task StartChatByUsername()
	{
		if (string.IsNullOrEmpty(_newChatUsername))
			return;

		var username = _newChatUsername.Trim();
		
		// Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø¢ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
		var targetUser = ChatService.GetAllUsers().FirstOrDefault(u => 
			u.Username.Equals(username, StringComparison.OrdinalIgnoreCase));

		if (targetUser == null)
		{
			// Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯
			Console.WriteLine($"User {username} not found");
			_newChatUsername = "";
			return;
		}

		// Ø´Ø±ÙˆØ¹ Ú†Øª Ø¨Ø§ Ú©Ø§Ø±Ø¨Ø±
		SelectedChatId = null;
		_selectedReceiverUsername = targetUser.Username;
		_newChatUsername = "";
		
		// threadÙ‡Ø§ Ø±Ø§ refresh Ú©Ù†
		LoadChatThreads();
		LoadPreviousChatUsers();
		await InvokeAsync(StateHasChanged);
	}

	private async void OnMessageReceived(object sender, MessageModel message)
	{
		if (message == null || string.IsNullOrEmpty(CurrentUser))
			return;

		// ÙÙ‚Ø· Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ Ø¨Ø§Ø´Ø¯ Ù„ÛŒØ³Øª Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù†
		var isRelated =
			message.Username == CurrentUser ||
			message.ReceiverUsername == CurrentUser ||
			!string.IsNullOrEmpty(message.ChatId);

		if (!isRelated)
			return;

		LoadChatThreads();
		LoadPreviousChatUsers();
		await InvokeAsync(StateHasChanged);
	}

	private void ShowCreateGroupChat()
	{
		_showCreateGroupDialog = true;
		_newChatName = "";
	}

	private void CloseCreateGroupDialog()
	{
		_showCreateGroupDialog = false;
		_newChatName = "";
	}

	private async Task HandleCreateGroupChat(List<string> participants)
	{
		if (participants == null || participants.Count < 1)
			return;

		try
		{
			var chatThread = ChatService.CreateGroupChat(participants, CurrentUser, _newChatName);
			SelectedChatId = chatThread.ChatId;
			_selectedReceiverUsername = null;
			LoadChatThreads();
			CloseCreateGroupDialog();
			await InvokeAsync(StateHasChanged);
			
			// Thread Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ØªØ§ Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯
			SelectedChatId = chatThread.ChatId;
			_selectedReceiverUsername = null;
		}
		catch (Exception ex)
		{
			// Log error - Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡ÛŒØ¯
			Console.WriteLine($"Error creating group chat: {ex.Message}");
		}
	}

	private string FormatTime(DateTime when)
	{
		var now = DateTime.Now;
		var diff = now - when;

		if (diff.TotalMinutes < 1)
			return "Ø§Ù„Ø§Ù†";
		if (diff.TotalHours < 1)
			return $"{(int)diff.TotalMinutes}Ù…";
		if (diff.TotalDays < 1)
			return $"{(int)diff.TotalHours}Ø³";
		if (diff.TotalDays < 7)
			return $"{(int)diff.TotalDays}Ø±";

		return when.ToString("MM/dd");
	}

	public void Dispose()
	{
		if (ChatService != null)
		{
			ChatService.MessageReceived -= OnMessageReceived;
		}
	}
}
