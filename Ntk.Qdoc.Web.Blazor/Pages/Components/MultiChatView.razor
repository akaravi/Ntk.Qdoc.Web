@inject IChatService ChatService
@using System.Linq
@using Microsoft.AspNetCore.Components.Forms
@using Ntk.Qdoc.Web.Blazor.Models

<div class="multi-chat-view">
	<div class="chat-threads-panel">
		<div class="chat-threads-header">
			<h3>Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</h3>
			<button class="btn btn-sm btn-primary" @onclick="ShowCreateGroupChat">
				<i class="fa fa-plus"></i> Ú†Øª Ø¬Ø¯ÛŒØ¯
			</button>
		</div>
		
		<div class="chat-threads-list">
			@if (_chatThreads != null && _chatThreads.Any())
			{
				foreach (var thread in _chatThreads)
				{
					var unreadCount = thread.GetUnreadCount(CurrentUser);
					var isSelected = false;
					
					// Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÙˆØ¯Ù† thread
					if (!string.IsNullOrEmpty(thread.ChatId))
					{
						isSelected = SelectedChatId == thread.ChatId;
					}
					else if (thread.Participants.Count == 2)
					{
						var otherParticipant = thread.Participants.FirstOrDefault(p => p != CurrentUser);
						isSelected = _selectedReceiverUsername == otherParticipant;
					}
					
					<div class="chat-thread-item @(isSelected ? "active" : "")" 
						 @onclick="() => SelectThread(thread)">
						<div class="thread-info">
							<div class="thread-name">
								@if (thread.IsGroupChat)
								{
									<i class="fa fa-users"></i>
								}
								else
								{
									<i class="fa fa-user"></i>
								}
								@thread.ChatName
							</div>
							<div class="thread-preview">@(string.IsNullOrEmpty(thread.LastMessagePreview) ? "Ø¨Ø¯ÙˆÙ† Ù¾ÛŒØ§Ù…" : thread.LastMessagePreview)</div>
						</div>
						@if (unreadCount > 0)
						{
							<span class="unread-badge">@unreadCount</span>
						}
						<div class="thread-time">@FormatTime(thread.LastMessageTime)</div>
					</div>
				}
			}
			else
			{
				<div class="empty-state">Ù‡ÛŒÚ† Ú†ØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>
			}
		</div>
	</div>

	<div class="chat-content-panel">
		@if (!string.IsNullOrEmpty(SelectedChatId))
		{
			<Chat CurrentUser="@CurrentUser" ChatId="@SelectedChatId" />
			<MessageForm LoggedUser="@_loggedUser" ChatId="@SelectedChatId" />
		}
		else if (!string.IsNullOrEmpty(_selectedReceiverUsername))
		{
			<Chat CurrentUser="@CurrentUser" ReceiverUsername="@_selectedReceiverUsername" />
			<MessageForm LoggedUser="@_loggedUser" ReceiverUsername="@_selectedReceiverUsername" />
		}
		else
		{
			<div class="empty-chat-state">
				<div class="empty-icon">ðŸ’¬</div>
				<p>ÛŒÚ© Ú†Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ú†Øª Ø¬Ø¯ÛŒØ¯ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯</p>
			</div>
		}
	</div>
</div>

@if (_showCreateGroupDialog)
{
	<div class="modal-overlay" @onclick="CloseCreateGroupDialog">
		<div class="modal-content" @onclick:stopPropagation="true">
			<div class="modal-header">
				<h3>Ø§ÛŒØ¬Ø§Ø¯ Ú†Øª Ú¯Ø±ÙˆÙ‡ÛŒ</h3>
				<button class="btn-close" @onclick="CloseCreateGroupDialog">Ã—</button>
			</div>
			<div class="modal-body">
				<div class="form-group">
					<label>Ù†Ø§Ù… Ú†Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
					<InputText @bind-Value="_newChatName" class="form-control" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªÛŒÙ… ØªÙˆØ³Ø¹Ù‡" />
				</div>
				<Users CurrentUser="@CurrentUser" AllowMultiSelect="true" 
					   OnCreateGroupChatRequested="@HandleCreateGroupChat" />
			</div>
		</div>
	</div>
}

@code {
	[Parameter]
	public string CurrentUser { get; set; }

	private IEnumerable<ChatThreadModel> _chatThreads;
	private string SelectedChatId { get; set; }
	private string _selectedReceiverUsername { get; set; }
	private bool _showCreateGroupDialog = false;
	private string _newChatName = "";
	private UserModel _loggedUser;

	protected override void OnInitialized()
	{
		_loggedUser = new UserModel(CurrentUser);
		LoadChatThreads();
	}

	private void LoadChatThreads()
	{
		if (!string.IsNullOrEmpty(CurrentUser))
		{
			// Ù†Ù…Ø§ÛŒØ´ ØªÙ…Ø§Ù… threadÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¢Ù†Ù‡Ø§ Ø§Ø³Øª (Ø­ØªÛŒ Ø¨Ø¯ÙˆÙ† Ù¾ÛŒØ§Ù…)
			_chatThreads = ChatService.GetChatThreadsForUser(CurrentUser);
		}
	}

	private void SelectThread(ChatThreadModel thread)
	{
		if (thread == null)
			return;

		// Ø§Ú¯Ø± thread Ú¯Ø±ÙˆÙ‡ÛŒ Ø§Ø³ØªØŒ Ø§Ø² ChatId Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
		if (!string.IsNullOrEmpty(thread.ChatId))
		{
			SelectedChatId = thread.ChatId;
			_selectedReceiverUsername = null;
		}
		else
		{
			// Ø§Ú¯Ø± thread Ø®ØµÙˆØµÛŒ Ø§Ø³ØªØŒ Ø§Ø² ReceiverUsername Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
			var otherParticipant = thread.Participants.FirstOrDefault(p => p != CurrentUser);
			if (!string.IsNullOrEmpty(otherParticipant))
			{
				_selectedReceiverUsername = otherParticipant;
				SelectedChatId = null;
			}
		}
		
		// Reset unread count when chat is selected
		thread.ResetUnreadCount(CurrentUser);
		InvokeAsync(StateHasChanged);
	}

	private void ShowCreateGroupChat()
	{
		_showCreateGroupDialog = true;
		_newChatName = "";
	}

	private void CloseCreateGroupDialog()
	{
		_showCreateGroupDialog = false;
		_newChatName = "";
	}

	private async Task HandleCreateGroupChat(List<string> participants)
	{
		if (participants == null || participants.Count < 1)
			return;

		try
		{
			var chatThread = ChatService.CreateGroupChat(participants, CurrentUser, _newChatName);
			SelectedChatId = chatThread.ChatId;
			_selectedReceiverUsername = null;
			LoadChatThreads();
			CloseCreateGroupDialog();
			await InvokeAsync(StateHasChanged);
			
			// Thread Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ØªØ§ Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯
			SelectedChatId = chatThread.ChatId;
			_selectedReceiverUsername = null;
		}
		catch (Exception ex)
		{
			// Log error - Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡ÛŒØ¯
			Console.WriteLine($"Error creating group chat: {ex.Message}");
		}
	}

	private string FormatTime(DateTime when)
	{
		var now = DateTime.Now;
		var diff = now - when;

		if (diff.TotalMinutes < 1)
			return "Ø§Ù„Ø§Ù†";
		if (diff.TotalHours < 1)
			return $"{(int)diff.TotalMinutes}Ù…";
		if (diff.TotalDays < 1)
			return $"{(int)diff.TotalHours}Ø³";
		if (diff.TotalDays < 7)
			return $"{(int)diff.TotalDays}Ø±";

		return when.ToString("MM/dd");
	}
}
