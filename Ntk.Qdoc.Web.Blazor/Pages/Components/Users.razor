@inject IChatService ChatService

@using System.Linq

<div class="users-panel fade-in">
	<div class="section-header">
		<h3 class="title mb-0">کاربران</h3>
		<div class="meta">
			<span class="badge-soft">@( (_users?.Count() ?? 0) ) کاربر</span>
			<span class="pill">
				<span class="status-dot"></span>
				@((_users?.Count(x => x.Client != null) ?? 0)) آنلاین
			</span>
		</div>
	</div>
	
	@if (AllowMultiSelect)
	{
		<div class="users-actions">
			@if (_selectedUsers.Any())
			{
				<button class="btn btn-sm btn-primary" @onclick="OnCreateGroupChat">
					<i class="fa fa-users"></i> شروع چت گروهی (@(_selectedUsers.Count))
				</button>
				<button class="btn btn-sm btn-ghost" @onclick="ClearSelection">
					<i class="fa fa-times"></i> لغو
				</button>
			}
		</div>
	}
	
	<div class='users-list p-2'>
		@if (null != _users)
		{
			if (_users.Any())
			{
				foreach (var user in _users)
				{
					var isSelected = _selectedUsers.Contains(user.Username);
					<div class="user-item @(isSelected ? "selected" : "")" @onclick="() => ToggleUserSelection(user.Username)">
						@if (AllowMultiSelect)
						{
							<input type="checkbox" checked="@isSelected" @onclick:stopPropagation="true" @onchange="() => ToggleUserSelection(user.Username)" />
						}
						<span class='user-status'>
							<span class="status-dot @( (null != user.Client) ? "" : "status-offline-dot")"></span>
						</span>
						<span class='user-icon status-@( (null != user.Client) ? "online" : "offline")'><i class="fa fa-user"></i></span>
						<span class="user-name">@user.Username</span>
					</div>
				}
			}
			else
			{
				<div class="empty-state">هیچ کاربری متصل نیست.</div>
			}
		}
		else
		{
			<div class="empty-state">در حال دریافت فهرست کاربران...</div>
		}
	</div>
</div>

@code {
	[Parameter]
	public string CurrentUser { get; set; }

	[Parameter]
	public bool AllowMultiSelect { get; set; } = false;

	[Parameter]
	public EventCallback<List<string>> OnCreateGroupChatRequested { get; set; }

	private IEnumerable<UserModel> _users;
	private HashSet<string> _selectedUsers = new HashSet<string>();

	protected override void OnInitialized()
	{
		ChatService.UserLoggedIn += OnUserLoggedIn;
		ChatService.UserLoggedOut += OnUserLoggedOut;
		_users = this.ChatService.GetAllUsers();
	}

	private async void OnUserLoggedIn(object sender, UserLoginEventArgs args)
	{
		_users = this.ChatService.GetAllUsers();
		await InvokeAsync(StateHasChanged);
	}

	private async void OnUserLoggedOut(object sender, UserLogoutEventArgs args)
	{
		_users = this.ChatService.GetAllUsers();
		await InvokeAsync(StateHasChanged);
	}

	private void ToggleUserSelection(string username)
	{
		if (!AllowMultiSelect)
			return;

		if (username == CurrentUser)
			return; // کاربر نمی‌تواند خودش را انتخاب کند

		if (_selectedUsers.Contains(username))
		{
			_selectedUsers.Remove(username);
		}
		else
		{
			_selectedUsers.Add(username);
		}
		
		InvokeAsync(StateHasChanged);
	}

	private void ClearSelection()
	{
		_selectedUsers.Clear();
		InvokeAsync(StateHasChanged);
	}

	private async Task OnCreateGroupChat()
	{
		if (_selectedUsers.Any() && OnCreateGroupChatRequested.HasDelegate)
		{
			await OnCreateGroupChatRequested.InvokeAsync(_selectedUsers.ToList());
			_selectedUsers.Clear();
		}
	}

	private void Dispose()
	{
		ChatService.UserLoggedIn -= OnUserLoggedIn;
		ChatService.UserLoggedOut -= OnUserLoggedOut;
	}
}