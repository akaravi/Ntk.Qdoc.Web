@using System.Linq
@inject IChatService ChatService
<div class="w-100 mb-3 chat-messages fade-in">
	@if (null != _messages && _messages.Count > 0)
	{
		<div class="section-header">
			<h3 class="title mb-0">پیام‌ها</h3>
			<div class="meta">
				<span class="badge-soft">@_messages.Count پیام</span>
			</div>
		</div>
		foreach (var message in _messages)
		{
			<p class='msg'>
				<div class='msg-meta'>
					@if (!string.IsNullOrEmpty(message.ReceiverUsername))
					{
						<span class='who'>@message.Username > @message.ReceiverUsername</span>
					}
					else
					{
						<span class='who'>@message.Username</span>
					}
					<span class='when'>@message.When</span>
				</div>
				<span class='what'>@message.Text</span>
			</p>
		}
	}
	else
	{
		<div class="empty-state">پیامی برای نمایش وجود ندارد.</div>
	}
</div>
@code {
	private List<MessageModel> _messages;

	protected override void OnInitialized()
	{
		ChatService.MessageReceived += OnMessage;

		_messages = new List<MessageModel>();
	}

	private async void OnMessage(object sender, MessageModel message)
	{
		_messages.Add(message);
		await InvokeAsync(StateHasChanged);
	}

	private void Dispose()
	{
		ChatService.MessageReceived -= OnMessage;
	}
        }
