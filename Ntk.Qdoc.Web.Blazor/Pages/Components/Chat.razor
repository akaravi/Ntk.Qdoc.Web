@using System.Linq
@using System
@inject IChatService ChatService
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="chat-container">
	<div class="chat-header">
		<h3 class="chat-title">پیام‌ها</h3>
		@if (_messages != null && _messages.Count > 0)
		{
			<span class="chat-count">@_messages.Count</span>
		}
	</div>
	<div class="chat-messages" @ref="_messagesContainer">
		@if (null != _messages && _messages.Count > 0)
		{
			foreach (var message in _messages)
			{
				// تشخیص اینکه آیا این پیام از کاربر فعلی است یا نه
				// در چت خصوصی: اگر Username برابر CurrentUser باشد، پیام از کاربر است
				// در چت گروهی: اگر Username برابر CurrentUser باشد، پیام از کاربر است
				var isMyMessage = !string.IsNullOrEmpty(CurrentUser) && 
								  !string.IsNullOrEmpty(message.Username) &&
								  message.Username.Trim().Equals(CurrentUser.Trim(), StringComparison.OrdinalIgnoreCase);
				
				// برای چت گروهی، نام فرستنده را نمایش می‌دهیم
				var isGroupChat = !string.IsNullOrEmpty(ChatId);
				var showSenderName = isGroupChat && !isMyMessage;
				
				<div class="message-wrapper @(isMyMessage ? "message-sent" : "message-received")">
					@if (!isMyMessage)
					{
						<div class="message-avatar">
							@GetAvatarInitial(message.Username)
						</div>
					}
					<div class="message-bubble">
						@if (showSenderName)
						{
							<div class="message-sender">@message.Username</div>
						}
						<div class="message-text">@message.Text</div>
						<div class="message-time">@FormatTime(message.When)</div>
					</div>
				</div>
			}
		}
		else
		{
			<div class="empty-state">
				<div class="empty-icon">💬</div>
				<p>هنوز پیامی ارسال نشده است</p>
				<span class="empty-hint">اولین پیام را ارسال کنید</span>
			</div>
		}
	</div>
</div>

@code {
	[Parameter]
	public string CurrentUser { get; set; }

	[Parameter]
	public string ChatId { get; set; }

	[Parameter]
	public string ReceiverUsername { get; set; }

	private List<MessageModel> _messages;
	private ElementReference _messagesContainer;

	protected override void OnInitialized()
	{
		ChatService.MessageReceived += OnMessage;
		_messages = new List<MessageModel>();
	}

	protected override async Task OnParametersSetAsync()
	{
		// وقتی پارامترها تغییر می‌کنند (مثل ReceiverUsername یا ChatId)، تاریخچه را دوباره بارگذاری کن
		LoadChatHistory();
		await base.OnParametersSetAsync();
		StateHasChanged();
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender && _messages != null && _messages.Count > 0)
		{
			await ScrollToBottom();
		}
		// بعد از هر رندر، اگر پیامی داریم، به پایین اسکرول کن
		if (_messages != null && _messages.Count > 0)
		{
			await ScrollToBottom();
		}
		await base.OnAfterRenderAsync(firstRender);
	}

	private void LoadChatHistory()
	{
		// همیشه لیست پیام‌ها را پاک کن و دوباره بارگذاری کن
		_messages = new List<MessageModel>();
		
		if (!string.IsNullOrEmpty(ChatId))
		{
			// بارگذاری پیام‌های چت گروهی
			var history = ChatService.GetMessagesForChat(ChatId, CurrentUser);
			if (history != null)
			{
				_messages = history.ToList();
			}
		}
		else if (!string.IsNullOrEmpty(ReceiverUsername))
		{
			// بارگذاری پیام‌های چت خصوصی
			var history = ChatService.GetPrivateChatMessages(CurrentUser, ReceiverUsername);
			if (history != null)
			{
				_messages = history.ToList();
			}
		}
	}

	private async void OnMessage(object sender, MessageModel message)
	{
		// فیلتر کردن پیام‌ها بر اساس ChatId یا ReceiverUsername
		bool shouldShow = false;

		if (!string.IsNullOrEmpty(ChatId))
		{
			// چت گروهی - نمایش اگر ChatId مطابقت داشته باشد
			shouldShow = message.ChatId == ChatId;
		}
		else if (!string.IsNullOrEmpty(ReceiverUsername))
		{
			// چت خصوصی - نمایش اگر پیام برای این دو کاربر باشد
			shouldShow = (message.Username == CurrentUser && message.ReceiverUsername == ReceiverUsername) ||
						(message.Username == ReceiverUsername && message.ReceiverUsername == CurrentUser);
		}
		else
		{
			// پیام عمومی - نمایش اگر receiver نداشته باشد
			shouldShow = message.IsPublicMessage;
		}

		if (shouldShow)
		{
			_messages.Add(message);

			// پخش صدای پیام جدید (دینگ)
			try
			{
				// فقط برای پیام‌هایی که از کاربر فعلی نیستند
				var isMyMessage = !string.IsNullOrEmpty(CurrentUser) &&
								  !string.IsNullOrEmpty(message.Username) &&
								  message.Username.Trim().Equals(CurrentUser.Trim(), StringComparison.OrdinalIgnoreCase) == false;
				if (isMyMessage)
				{
					await JSRuntime.InvokeVoidAsync("playMessageSound");
				}
			}
			catch
			{
				// در صورت بروز خطا در صدا، چت همچنان باید کار کند
			}

			await InvokeAsync(StateHasChanged);
			await ScrollToBottom();
		}
	}

	private async Task ScrollToBottom()
	{
		try
		{
			await JSRuntime.InvokeVoidAsync("scrollChatToBottom", _messagesContainer);
		}
		catch { }
	}

	private string FormatTime(DateTime when)
	{
		var now = DateTime.Now;
		var diff = now - when;

		if (diff.TotalMinutes < 1)
			return "الان";
		if (diff.TotalHours < 1)
			return $"{(int)diff.TotalMinutes} دقیقه پیش";
		if (diff.TotalDays < 1)
			return $"{(int)diff.TotalHours} ساعت پیش";
		if (diff.TotalDays < 7)
			return $"{(int)diff.TotalDays} روز پیش";
		
		return when.ToString("dd MMM yyyy HH:mm");
	}

	private string GetAvatarInitial(string username)
	{
		if (string.IsNullOrEmpty(username))
			return "?";
		
		return username.Substring(0, Math.Min(1, username.Length)).ToUpper();
	}

	public void Dispose()
	{
		if (ChatService != null)
		{
			ChatService.MessageReceived -= OnMessage;
		}
	}
}
